<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Image Diagnostic Tool</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px; 
            max-width: 1000px; 
            margin: 0 auto;
            background: #f5f5f5;
        }
        .diagnostic-section { 
            background: white; 
            margin: 20px 0; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button { 
            background: #007bff; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px;
        }
        .test-button:hover { background: #0056b3; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .info { color: #17a2b8; font-weight: bold; }
        .code { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 4px; 
            font-family: monospace; 
            margin: 10px 0;
        }
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .image-test {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }
        .test-image {
            max-width: 100%;
            max-height: 200px;
            border: 2px solid #ddd;
            border-radius: 4px;
        }
        .log {
            background: #1e1e1e;
            color: #fff;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>üîß Complete Image Diagnostic Tool</h1>
    
    <div class="diagnostic-section">
        <h2>üåê Backend Server Tests</h2>
        <button class="test-button" onclick="testBackendHealth()">Test Backend Health</button>
        <button class="test-button" onclick="testCORS()">Test CORS Headers</button>
        <button class="test-button" onclick="testImageEndpoint()">Test Image Endpoint</button>
        <div id="backend-results"></div>
    </div>

    <div class="diagnostic-section">
        <h2>üìÇ File System Tests</h2>
        <button class="test-button" onclick="testFileAccess()">Test File Access</button>
        <button class="test-button" onclick="listAvailableImages()">List Available Images</button>
        <div id="filesystem-results"></div>
    </div>

    <div class="diagnostic-section">
        <h2>üñºÔ∏è Image Loading Tests</h2>
        <button class="test-button" onclick="runImageTests()">Run All Image Tests</button>
        <button class="test-button" onclick="clearImageTests()">Clear Results</button>
        <div id="image-results"></div>
    </div>

    <div class="diagnostic-section">
        <h2>üîç Network Analysis</h2>
        <button class="test-button" onclick="analyzeNetworkRequests()">Analyze Network</button>
        <div id="network-results"></div>
    </div>

    <div class="diagnostic-section">
        <h2>üìã Console Log</h2>
        <div id="console-log" class="log">Diagnostic tool ready...\n</div>
        <button class="test-button" onclick="clearLog()">Clear Log</button>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001';
        
        // Available test images (from your uploads directory)
        const testImages = [
            'report-1751702494750-370496652.png',
            'report-1754490952892-989447507.png',
            'report-1754490957300-47686100.png',
            'report-1754490990625-580073881.png',
            'report-1754491519331-729671733.png',
            'report-1754492130038-528378644.png',
            'report-1754492137109-569429038.png',
            'report-1754530683320-493354998.png'
        ];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('console-log');
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('console-log').textContent = 'Log cleared...\n';
        }

        async function testBackendHealth() {
            const resultsDiv = document.getElementById('backend-results');
            resultsDiv.innerHTML = '<div class="info">Testing backend health...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/api/health`);
                const data = await response.json();
                
                if (response.ok) {
                    resultsDiv.innerHTML = `
                        <div class="success">‚úÖ Backend Health: OK</div>
                        <div class="code">
                            Status: ${data.status}<br>
                            Uptime: ${Math.round(data.uptime)} seconds<br>
                            Timestamp: ${data.timestamp}
                        </div>
                    `;
                    log('Backend health check passed', 'success');
                } else {
                    resultsDiv.innerHTML = `<div class="error">‚ùå Backend health check failed: ${response.status}</div>`;
                    log(`Backend health check failed: ${response.status}`, 'error');
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error">‚ùå Cannot connect to backend</div>
                    <div class="code">Error: ${error.message}</div>
                    <div class="warning">Make sure backend is running on port 3001</div>
                `;
                log(`Backend connection failed: ${error.message}`, 'error');
            }
        }

        async function testCORS() {
            const resultsDiv = document.getElementById('backend-results');
            
            try {
                const response = await fetch(`${API_BASE}/uploads/test-cors`, {
                    method: 'HEAD',
                    mode: 'cors'
                });
                
                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers')
                };
                
                resultsDiv.innerHTML += `
                    <div class="success">‚úÖ CORS Test: Headers detected</div>
                    <div class="code">
                        CORS Headers:<br>
                        ${Object.entries(corsHeaders).map(([key, value]) => `${key}: ${value || 'Not set'}`).join('<br>')}
                    </div>
                `;
                log('CORS headers test completed', 'success');
            } catch (error) {
                resultsDiv.innerHTML += `
                    <div class="error">‚ùå CORS Test Failed</div>
                    <div class="code">Error: ${error.message}</div>
                `;
                log(`CORS test failed: ${error.message}`, 'error');
            }
        }

        async function testImageEndpoint() {
            const resultsDiv = document.getElementById('backend-results');
            
            try {
                const testImageUrl = `${API_BASE}/uploads/${testImages[0]}`;
                const response = await fetch(testImageUrl, { method: 'HEAD' });
                
                if (response.ok) {
                    const contentType = response.headers.get('Content-Type');
                    const contentLength = response.headers.get('Content-Length');
                    
                    resultsDiv.innerHTML += `
                        <div class="success">‚úÖ Image Endpoint: Working</div>
                        <div class="code">
                            URL: ${testImageUrl}<br>
                            Content-Type: ${contentType}<br>
                            Content-Length: ${contentLength} bytes<br>
                            Status: ${response.status}
                        </div>
                    `;
                    log(`Image endpoint test passed for ${testImages[0]}`, 'success');
                } else {
                    resultsDiv.innerHTML += `
                        <div class="error">‚ùå Image Endpoint: Failed (${response.status})</div>
                    `;
                    log(`Image endpoint test failed: ${response.status}`, 'error');
                }
            } catch (error) {
                resultsDiv.innerHTML += `
                    <div class="error">‚ùå Image Endpoint Test Failed</div>
                    <div class="code">Error: ${error.message}</div>
                `;
                log(`Image endpoint test error: ${error.message}`, 'error');
            }
        }

        async function testFileAccess() {
            const resultsDiv = document.getElementById('filesystem-results');
            resultsDiv.innerHTML = '<div class="info">Testing file access...</div>';
            
            let successCount = 0;
            let errorCount = 0;
            
            for (const filename of testImages) {
                try {
                    const response = await fetch(`${API_BASE}/uploads/${filename}`, { method: 'HEAD' });
                    if (response.ok) {
                        successCount++;
                        log(`File accessible: ${filename}`, 'success');
                    } else {
                        errorCount++;
                        log(`File not accessible: ${filename} (${response.status})`, 'error');
                    }
                } catch (error) {
                    errorCount++;
                    log(`File access error: ${filename} - ${error.message}`, 'error');
                }
            }
            
            resultsDiv.innerHTML = `
                <div class="success">‚úÖ Files accessible: ${successCount}</div>
                <div class="error">‚ùå Files not accessible: ${errorCount}</div>
                <div class="info">Total files tested: ${testImages.length}</div>
            `;
        }

        async function listAvailableImages() {
            const resultsDiv = document.getElementById('filesystem-results');
            
            resultsDiv.innerHTML += `
                <div class="info">üìÇ Test Image Files:</div>
                <div class="code">
                    ${testImages.map(img => `${img} - ${API_BASE}/uploads/${img}`).join('<br>')}
                </div>
            `;
            log(`Listed ${testImages.length} test images`, 'info');
        }

        function runImageTests() {
            const resultsDiv = document.getElementById('image-results');
            resultsDiv.innerHTML = '<h3>Image Loading Tests</h3>';
            
            const imageGrid = document.createElement('div');
            imageGrid.className = 'image-grid';
            
            testImages.forEach((filename, index) => {
                const imageUrl = `${API_BASE}/uploads/${filename}`;
                
                const imageDiv = document.createElement('div');
                imageDiv.className = 'image-test';
                imageDiv.innerHTML = `
                    <h4>Test ${index + 1}: ${filename}</h4>
                    <div class="code" style="font-size: 10px; margin-bottom: 10px;">
                        URL: ${imageUrl}
                    </div>
                    <img 
                        class="test-image" 
                        src="${imageUrl}"
                        alt="Test Image ${index + 1}"
                        onload="handleImageSuccess(this, '${filename}')"
                        onerror="handleImageError(this, '${filename}')"
                    />
                    <div id="status-${index}">Loading...</div>
                `;
                
                imageGrid.appendChild(imageDiv);
            });
            
            resultsDiv.appendChild(imageGrid);
            log('Started image loading tests', 'info');
        }

        function handleImageSuccess(img, filename) {
            const index = testImages.indexOf(filename);
            const statusDiv = document.getElementById(`status-${index}`);
            statusDiv.innerHTML = `
                <div class="success">‚úÖ Loaded successfully</div>
                <div style="font-size: 12px;">Size: ${img.naturalWidth}x${img.naturalHeight}px</div>
            `;
            log(`Image loaded successfully: ${filename}`, 'success');
        }

        function handleImageError(img, filename) {
            const index = testImages.indexOf(filename);
            const statusDiv = document.getElementById(`status-${index}`);
            statusDiv.innerHTML = `
                <div class="error">‚ùå Failed to load</div>
                <div style="font-size: 12px;">Check Network tab for details</div>
            `;
            log(`Image failed to load: ${filename}`, 'error');
            
            // Replace with fallback
            img.style.display = 'none';
            const fallback = document.createElement('div');
            fallback.style.cssText = 'width: 100%; height: 200px; background: #f8f9fa; border: 2px dashed #dee2e6; display: flex; align-items: center; justify-content: center; color: #6c757d; border-radius: 4px;';
            fallback.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 8px;">üì∑</div>
                    <div style="font-size: 14px;">Image not available</div>
                    <div style="font-size: 10px; margin-top: 4px; word-break: break-all;">${filename}</div>
                </div>
            `;
            img.parentNode.appendChild(fallback);
        }

        function clearImageTests() {
            document.getElementById('image-results').innerHTML = '';
            log('Image test results cleared', 'info');
        }

        function analyzeNetworkRequests() {
            const resultsDiv = document.getElementById('network-results');
            resultsDiv.innerHTML = `
                <div class="info">üîç Network Analysis Instructions:</div>
                <div class="code">
                    1. Open Browser DevTools (F12)<br>
                    2. Go to Network tab<br>
                    3. Clear existing requests<br>
                    4. Run image tests above<br>
                    5. Look for failed requests (red status)<br>
                    6. Check response headers for CORS issues<br>
                    7. Verify file paths are correct
                </div>
                <div class="warning">‚ö†Ô∏è Common Issues:</div>
                <div class="code">
                    ‚Ä¢ 404 Not Found: File doesn't exist on server<br>
                    ‚Ä¢ CORS errors: Cross-origin access blocked<br>
                    ‚Ä¢ Connection refused: Backend server not running<br>
                    ‚Ä¢ Timeout: Server overloaded or network issues
                </div>
            `;
            log('Network analysis instructions displayed', 'info');
        }

        // Auto-run basic tests on page load
        window.onload = function() {
            log('Diagnostic tool loaded', 'info');
            setTimeout(() => {
                testBackendHealth();
            }, 1000);
        };
    </script>
</body>
</html>
