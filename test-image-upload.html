<!DOCTYPE html>
<html>
<head>
    <title>Test Image Upload</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .error { color: red; margin-top: 10px; }
        .success { color: green; margin-top: 10px; }
        .debug { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>Test Image Upload for Reports</h1>
    
    <form id="reportForm">
        <div class="form-group">
            <label>Type:</label>
            <select id="type" required>
                <option value="">Select Type</option>
                <option value="emergency">Emergency Alert</option>
                <option value="caution">Caution Alert</option>
                <option value="construction">Construction Alert</option>
                <option value="info">Information Alert</option>
                <option value="safe">Safe Message</option>
                <option value="pothole">Pothole</option>
                <option value="debris">Road Debris</option>
                <option value="flooding">Flooding</option>
                <option value="accident">Accident</option>
                <option value="other">Other</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Severity:</label>
            <select id="severity" required>
                <option value="">Select Severity</option>
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
                <option value="critical">Critical</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Description:</label>
            <textarea id="description" rows="4" required minlength="10" maxlength="500" placeholder="Please provide at least 10 characters describing the issue..."></textarea>
        </div>
        
        <div class="form-group">
            <label>Image:</label>
            <input type="file" id="image" accept="image/*" required>
        </div>
        
        <button type="submit" id="submitBtn">Submit Report</button>
        <button type="button" id="getLocationBtn">Get My Location</button>
    </form>
    
    <div id="status"></div>
    <div id="debug" class="debug"></div>

    <script>
        const API_BASE = 'http://192.168.1.150:3001';
        let currentLocation = null;
        let token = null;

        // Test login first
        async function testLogin() {
            try {
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: 'test@example.com', 
                        password: 'password123' 
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    token = data.token;
                    updateDebug('‚úÖ Login successful, token: ' + token.substring(0, 20) + '...');
                    return true;
                } else {
                    updateDebug('‚ùå Login failed: ' + response.status);
                    return false;
                }
            } catch (error) {
                updateDebug('‚ùå Login error: ' + error.message);
                return false;
            }
        }

        // Get location
        document.getElementById('getLocationBtn').onclick = () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        updateDebug('üìç Location: ' + JSON.stringify(currentLocation));
                    },
                    (error) => {
                        updateDebug('‚ùå Location error: ' + error.message);
                        // Use default Kabankalan coordinates for testing
                        currentLocation = { lat: 10.1869, lng: 122.8081 };
                        updateDebug('üìç Using default location: ' + JSON.stringify(currentLocation));
                    }
                );
            } else {
                currentLocation = { lat: 10.1869, lng: 122.8081 };
                updateDebug('üìç Using default location: ' + JSON.stringify(currentLocation));
            }
        };

        // Submit form
        document.getElementById('reportForm').onsubmit = async (e) => {
            e.preventDefault();
            
            if (!token) {
                showStatus('Please wait, logging in...', 'error');
                const loginSuccess = await testLogin();
                if (!loginSuccess) {
                    showStatus('Login failed. Please check backend server.', 'error');
                    return;
                }
            }
            
            if (!currentLocation) {
                showStatus('Please get your location first', 'error');
                return;
            }
            
            const fileInput = document.getElementById('image');
            const description = document.getElementById('description').value;
            if (description.length < 10) {
                showStatus('Description must be at least 10 characters long', 'error');
                return;
            }
            
            if (description.length > 500) {
                showStatus('Description must be less than 500 characters', 'error');
                return;
            if (!fileInput.files[0]) {
                showStatus('Please select an image', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            if (file.size > 5 * 1024 * 1024) {
                showStatus('Image file is too large. Please select a file smaller than 5MB.', 'error');
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                showStatus('Please select a valid image file.', 'error');
                return;
            }
            updateDebug('üìÅ File info: ' + JSON.stringify({
                name: file.name,
                size: file.size,
                type: file.type
            }));
            
            const formData = new FormData();
            formData.append('type', document.getElementById('type').value);
            formData.append('severity', document.getElementById('severity').value);
            formData.append('description', document.getElementById('description').value);
            formData.append('location[address]', `${currentLocation.lat}, ${currentLocation.lng}`);
            formData.append('location[coordinates][latitude]', currentLocation.lat);
            formData.append('location[coordinates][longitude]', currentLocation.lng);
            formData.append('images', file);
            
            updateDebug('üì§ Submitting form data...');
            document.getElementById('submitBtn').disabled = true;
            
            try {
                const response = await fetch(`${API_BASE}/api/reports/user`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const responseText = await response.text();
                updateDebug('üì• Response status: ' + response.status);
                updateDebug('üì• Response text: ' + responseText);
                
                if (response.ok) {
                    const data = JSON.parse(responseText);
                    showStatus('Report submitted successfully!', 'success');
                    updateDebug('‚úÖ Report ID: ' + data.report._id);
                    if (data.report.images && data.report.images[0]) {
                        updateDebug('üñºÔ∏è Image saved as: ' + data.report.images[0].filename);
                        // Test image access
                        testImageAccess(data.report.images[0].filename);
                    }
                } else {
                    showStatus('Submit failed: ' + response.status, 'error');
                    updateDebug('‚ùå Error response: ' + responseText);
                }
            } catch (error) {
                showStatus('Network error: ' + error.message, 'error');
                updateDebug('‚ùå Network error: ' + error.message);
            } finally {
                document.getElementById('submitBtn').disabled = false;
            }
        };
        
        // Test image access
        async function testImageAccess(filename) {
            const imageUrl = `${API_BASE}/uploads/${filename}`;
            updateDebug('üîó Testing image URL: ' + imageUrl);
            
            try {
                const response = await fetch(imageUrl);
                if (response.ok) {
                    updateDebug('‚úÖ Image accessible at: ' + imageUrl);
                    // Show the image
                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.style.maxWidth = '300px';
                    img.style.marginTop = '10px';
                    document.getElementById('debug').appendChild(img);
                } else {
                    updateDebug('‚ùå Image not accessible: ' + response.status);
                }
            } catch (error) {
                updateDebug('‚ùå Image access error: ' + error.message);
            }
        }

        function updateDebug(message) {
            const debug = document.getElementById('debug');
            debug.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
            debug.scrollTop = debug.scrollHeight;
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.innerHTML = '<div class="' + type + '">' + message + '</div>';
        }

        // Auto-login on page load
        window.onload = () => {
            updateDebug('üöÄ Page loaded, testing connection...');
            testLogin();
        };
    </script>
</body>
</html>
